---
layout: post
title: Java密码学 - 8. 数字签名
date: 2017-08-06 23:25:32
categories: 计算机
tags: 安全 
comments: 1
---

**数字签名**（又称公钥**数字签名**、电子签章）是一种类似写在纸上的普通的物理**签名**，但是使用了公钥加密领域的技术实现，用于鉴别**数字**信息的方法。 一套**数字签名**通常定义两种互补的运算，一个用于**签名**，另一个用于验证。

<br>

##### 原理

传送门：[数字签名是什么？](http://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html)

<br>

##### 代码实现

**非PKCS7的数字签名**

源代码[传送门](https://www.mkyong.com/java/java-digital-signatures-example/)

<br>

代码片段：**签名**

```java
	//The method that signs the data using the private key that is stored in keyFile path
	public byte[] sign(String data, String keyFile) throws InvalidKeyException, Exception{
		Signature rsa = Signature.getInstance("SHA1withRSA");
		rsa.initSign(getPrivate(keyFile));//使用私钥
		rsa.update(data.getBytes());//原文
		return rsa.sign();
	}
```

代码片段：**验证**
```java
private boolean verifySignature(byte[] data, byte[] signature, String keyFile) throws Exception {
		Signature sig = Signature.getInstance("SHA1withRSA");
		sig.initVerify(getPublic(keyFile));//使用公钥
		sig.update(data);//密文
		return sig.verify(signature);//验证
	}
```
<br>

##### PKCS7的数字签名

**签名**需要：

1.  证书(可以一个, 也可以多个, 目的, 让对方知道自己的身份)
2.  私钥(签名使用)
3.  原文
4.  摘要以及加密算法


```java
public static CMSSignedData generateCMSSignedData(PrivateKey privateKey, X509Certificate signCert, byte[] inputData, String algo)throws Exception {
		Security.addProvider(new BouncyCastleProvider());//这里我们使用BC的代码库
		CMSTypedData msg = new CMSProcessableByteArray(inputData);//
		CMSSignedDataGenerator gen = new CMSSignedDataGenerator();
		gen.addSignerInfoGenerator(
				new JcaSimpleSignerInfoGeneratorBuilder()
						.setProvider("BC")
						.build(algo, privateKey, signCert));//算法可选"SHA1withRSA"
		gen.addCertificate(new JcaX509CertificateHolder(signCert));
		//gen.addCertificates(new JcaCertStore(Arrays.asList(signCert))); 添加若干个证书时候用
		return gen.generate(msg, true);//这里的true和false, 是原文是否要放在CMSSignedData里
	}
```

**验签**需要：

- 密文
- 公钥

```java
private void doverify(PublicKey publickey,byte[] data) throws Exception {
		Security.addProvider(new BouncyCastleProvider());
		CMSSignedData cms = new CMSSignedData(data);//密文
		//获取签名者所有信息
		SignerInformationStore signers = cms.getSignerInfos();
		Iterator it = signers.getSigners().iterator();
		while (it.hasNext()) {
			SignerInformation signer = (SignerInformation) it.next();
			if (signer.verify(new JcaSimpleSignerInfoVerifierBuilder() .setProvider("BC").build(publickey))) {//共要
				System.out.println("verified");
				System.out.println();
			}

		}
	}
```

<br>

延申：如何获取原文

```
CMSSignedData cms=...
CMSTypedData signedContent = cms.getSignedContent();
System.out.println(new String((byte[])signedContent.getContent()));//获得原文数据
```

<br>

##### 参考：ASN.1格式

```
- Signed Data
signed-data PKCS7-CONTENT-TYPE ::= {SignedData
                                    IDENTIFIED BY  id-signed-data
}

SignedData ::= SEQUENCE {
  version           Version,
  digestAlgorithms  DigestAlgorithmIdentifiers,
  contentInfo       ContentInfo,
  certificates      [0]  CertificateSet OPTIONAL,
  crls              [1]  CertificateRevocationLists OPTIONAL,
  signerInfos       SignerInfos
}

SignerInfo ::= SEQUENCE {
  version                    Version,
  signerIdentifier           SignerIdentifier,
  digestAlgorithm            DigestAlgorithmIdentifier,
  authenticatedAttributes    [0]  Attributes OPTIONAL,
  digestEncryptionAlgorithm  DigestEncryptionAlgorithmIdentifier,
  encryptedDigest            EncryptedDigest,
  unauthenticatedAttributes  [1]  Attributes OPTIONAL
}
```


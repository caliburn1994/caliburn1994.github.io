---
layout: post
title: 单元测试浅谈（2）——CRUD
date: 2019-2-04 23:56:01
categories: 计算机
tags: 设计思想
comments: 1
typora-root-url: ..
excerpt: 单元测试浅谈，一些实际案例的分析。
---



## CRUD（增删改查）

如何编写关于CRUD的单元测试

1. 模拟数据库

2. 不测试数据库
3. 不测试

### （1） 模拟数据库

```java
class UserAddbiz{
    
    AbstractDao dao;
    
    pulic void run(User user){
        String rsl=null;
        if(条件){
             dao.add(user) 
        }else{
            rsl="error"
        }        
    }
    
    public testRun(){
        UserAddbiz biz = new UserAddbiz();
        biz.setDao(stubDao);//输入模拟数据库（stub/mock）
        biz.run(user)
    }  
    
}
```

### （2）不测试数据库

```java
class UserAddbiz{
    
    AbstractDao dao;
    
    pulic void run(User user){
        String rsl=null;
        if(isTrue(user)){
             dao.add(user) 
        }else{
            rsl="error"
        }        
    }
    
    public String isTrue(User user){
        //条件判断
        return rsl;
    }
    
    public testIsTrue(){
    	String rls= isTrue(new user(数据));
        assert//判断rsl
    }      
}
```

*（1）（2）区别*在于：（2）不对dao进行测试。

探讨：

从目的性出发，当需要被测试的内容wrapped起来的话，只对wrapped内的代码进行测试（仅对isTrue进行测试）和测试所有内容是同等效果的，并且前者更为简洁容易写。

从该角度上看，我不认同网上所谓的一刀切，private method和protect method不测。当然，在非wrapped形式的代码上，使用stub和mock更为合适。

<br>

### （1.1）内存数据库（In-memory database）

*[内存数据库]:**In-memory** database（IMDB）,即内存数据库，是一种依赖于主存作为数据存储介质的一种数据库管理系统。

对于CRUD的测试，有一类程序员提议使用H2内存数据库当作模拟用的数据库。有的程序员认为这是[集成测试](#集成测试)，认为单元测试不应该如此操作。原因如下：

*[集成测试]: **整合测试**又称**组装测试**，即对[程序模块](https://zh.wikipedia.org/w/index.php?title=%E7%A8%8B%E5%BA%8F%E6%A8%A1%E5%9D%97&action=edit&redlink=1)采用一次性或增值方式组装起来，对系统的[接口](https://zh.wikipedia.org/wiki/%E6%8E%A5%E5%8F%A3)进行正确性检验的测试工作。整合测试一般在[单元测试](https://zh.wikipedia.org/wiki/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95)之后、[系统测试](https://zh.wikipedia.org/wiki/%E7%B3%BB%E7%BB%9F%E6%B5%8B%E8%AF%95)之前进行。实践表明，有时模块虽然可以单独工作，但是并不能保证组装起来也可以同时工作。

- 集成测试拥有外部依赖，常常是长耗时的。这类型分析是基于硬件设备的这个大前提，而技术的更新必然的结果是耗时越来越低。另外，H2内存数据库已经耗时低了。
- 集成测试是大范围测试，必然不能精确出错位置。但是若DAO层使用的代码得到保证，那么service层使用集成测试并不会造成错误位置的无法确认。

内存数据库也存在一些问题。

1. 内存数据库和真实数据库并不是一一对应的。也就意味着，该测试只能针对通用性的操作。（例如：SQL查询语句、滚回等操作）
   ![1548578797084](/../assets/blog_res/1548578754622.png)

因此，使用内存数据库只能是一种简单的方式，项目仍旧需要使用其他方式进行补充单元测试。

更详细的说明，步移至：[Don't use In-Memory Databases (H2, Fongo) for Tests](https://blog.philipphauer.de/dont-use-in-memory-databases-tests-h2/)

<br>

### （1.2）Docker数据库

通过使用docker部署的数据库，可以达到理想化的测试模拟（docker的部署坏境和生产环境是一致的）。然而问题在于，如此理想化的模拟，究竟需要使用多少CPU（运行时间）呢？

<br>

### （3）不测试

对于操作极为重复的CRUD，基本是不可能出错的，通过测试DAO的基本功能，我们就不必再写CRUD的代码。然后就如同（2）那样，将非CRUD的逻辑独立起来，单独测试。或者仅仅通过注释和code review的方式进行BUG预防。
---
layout: post 
title: Azure - 2.Azure Data Facotry åŠŸèƒ½ä¸€æ 
tags: Cloud
comments: 1 
excerpt: Aazure Data Facotryçš„ç¬”è®°-2 åŠŸèƒ½ä¸€æ 
typora-root-url: ..\..\..\..
typora-copy-images-to: ..\..\..\..\assets\blog_res\azure
---

## Copy Activity

### æ¦‚å¿µ

source: æ•°æ®æº

[sink](https://en.wikipedia.org/wiki/Sink_(computing)): æ¥æ”¶å™¨ (åŸæ„: æ°´æ§½ï¼Œæ´—ç¢—æ§½)

Hierarchical  åˆ†å±‚ï¼šJSONã€XMLã€NoSQL

tabular : è¡¨æ ¼ï¼ˆexcelã€å…³ç³»æ•°æ®åº“ï¼‰

### æ€§èƒ½

æ¦‚å¿µğŸ“™

DIU (Data Integration Unit) [^1]è¿™æ˜¯ Azureäº‘ ç‰¹æœ‰çš„æ¦‚å¿µï¼Œä»‹ç»çš„æ–‡æ¡£æ¯”è¾ƒå°‘ä¸”æ¨¡ç³Šä¸æ¸…ï¼Œç¬”è€…è®¤ä¸ºåº”è§£é‡Šä¸º "å•ä½æ—¶é—´å†…ï¼ŒCPUã€å†…å­˜ã€ç½‘ç»œèµ„æºåˆ†é…ç­‰æ¶ˆè€—çš„æ—¶é—´"

ç­–ç•¥â™

-  [For Each ](https://docs.microsoft.com/en-us/azure/data-factory/control-flow-for-each-activity) å¹¶è¡Œæ‰§è¡Œï¼Œå¹¶ä¿®æ”¹ BatchCountï¼Œä½¿ä¹‹å¯é«˜å¹¶è¡Œã€‚
-  Copy Activity çš„æ€§èƒ½
  ![ç›‘è§†å¤åˆ¶æ´»åŠ¨è¿è¡Œè¯¦ç»†ä¿¡æ¯](/assets/blog_res/azure/monitor-copy-activity-run-details.png)
  1. Azure æä¾›äº†[æ€§èƒ½ä¼˜åŒ– (performance tuning) æç¤º](https://docs.microsoft.com/en-us/azure/data-factory/copy-activity-performance-troubleshooting)åŠŸèƒ½
     - [å¹¶è¡Œæ•°çš„è°ƒä¼˜](https://docs.microsoft.com/en-us/azure/data-factory/copy-activity-performance-features#parallel-copy)
     - [é¢—ç²’å¤§å°çš„è°ƒä¼˜](https://docs.microsoft.com/en-us/azure/data-factory/copy-activity-performance-features#data-integration-units)
  2. **Duration** çš„å†…å®¹å¸¸ä¸ºä¼˜åŒ–çš„å¯¹è±¡ã€‚[^3]
  3. [æš‚å­˜ (staging) åŠŸèƒ½](https://docs.microsoft.com/en-us/azure/data-factory/copy-activity-performance-features#staged-copy)  (Specify whether to copy data via an interim staging store. Enable staging only for the beneficial scenarios, e.g. load data into Azure Synapse Analytics via PolyBase, load data to/from Snowflake, load data from Amazon Redshift via UNLOAD or from HDFS via DistCp, etc.[Learn more](https://go.microsoft.com/fwlink/?linkid=2159335))

### Schemaæ˜ å°„  Schema Mapping

Copy Activity æœ‰ä¸€ç³»åˆ—é»˜è®¤çš„æ˜ å°„ç­–ç•¥ã€‚è€Œé…ç½®æ˜¾å¼æ˜ å°„ (Explicit mapping) æ—¶ï¼Œéœ€åŠ æ³¨æ„ï¼Œä¸åŒçš„ source-sink ç»„åˆé…ç½®çš„æ–¹å¼æ˜¯ä¸åŒã€‚[^2]

![ä»è¡¨æ ¼æ˜ å°„åˆ°è¡¨æ ¼](/assets/blog_res/azure/map-tabular-to-tabular.png)

Mapping æ”¯æŒ *Fatten* æ“ä½œï¼Œå¯ä»¥è®²ä¸€ä¸ª array æ‰å¹³åŒ–ã€‚è¿™æ–¹ä¾¿ JSON è½¬æ¢æˆ table

![ä½¿ç”¨ UI ä»åˆ†å±‚æ˜ å°„åˆ°è¡¨æ ¼](/assets/blog_res/azure/map-hierarchical-to-tabular-ui.png)







### æ•°æ®ä¸€è‡´æ€§éªŒè¯ Data consistency verification

Copy Activity æä¾›äº†æ•°æ®<div class='sup' data-title="ä»¥ç¡®ä¿æ•°æ®ä¸ä»…æˆåŠŸåœ°ä»æºå­˜å‚¨å¤åˆ¶åˆ°ç›®æ ‡å­˜å‚¨ï¼Œè€Œä¸”éªŒè¯äº†æºå­˜å‚¨å’Œç›®æ ‡å­˜å‚¨ä¹‹é—´çš„ä¸€è‡´æ€§ã€‚">ä¸€è‡´æ€§éªŒè¯</div>ã€‚é€šè¿‡ `validateDataConsistency` å¯åŠ¨è¯¥æ ¡éªŒã€‚[^5]

æ ¡éªŒçš„*å¯¹è±¡*ä»¥åŠ*ç­–ç•¥*â™˜

- äºŒè¿›åˆ¶å¯¹è±¡ï¼šfile size, lastModifiedDate, MD5 checksum 
- è¡¨æ ¼æ•°æ®ï¼ˆtabular dataï¼‰ï¼š` è¯»å–çš„è¡Œæ•° = å¤åˆ¶çš„è¡Œæ•° + è·³è¿‡çš„è¡Œæ•°`

*ä»€ä¹ˆæ—¶å€™å‘ç”Ÿï¼Ÿ*ğŸ“…[^4]

- ä¸»é”®é‡å¤
- ä½œä¸º source çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸èƒ½è®¿é—®ã€è¢«åˆ é™¤

å½“æ•°æ®å‘ç”Ÿ *ä¸ä¸€è‡´æ€§*âš ï¸æ—¶ï¼Œå¯ä»¥é€šè¿‡ `dataInconsistency` è®¾ç½®è¡Œä¸º

- ä¸­æ­¢
- è·³è·ƒ

åœ¨è®¾å®š `logSettings` å’Œ `path` å¯ä»¥è®°å½• *ä¸ä¸€è‡´* æ—¶å€™çš„æ—¥å¿—ã€‚

### ç›‘æ§Â·å®¹é”™Â·æµ‹è¯• MonitorÂ·Fault toleranceÂ·Test

ğŸ’¿æ•°æ®ä¸ä¸€è‡´

å½“ *ä¸å…è®¸æ•°æ®ä¸ä¸€è‡´* é‚£ä¹ˆ Copy Activity å°†é‡è¯•æˆ–è€…ä¸­æ­¢ã€‚ä¸­æ­¢æ—¶ï¼Œpipeline å°†ä»¥å¤±è´¥çš„å½¢å¼è¿”å›ï¼Œæ­¤æ—¶å¯ä»¥

1. å‘é€é‚®ä»¶é€šçŸ¥
2. å®šæœŸæŸ¥çœ‹ ç›‘æ§ (monitor) æƒ…å†µ 

å½“ *å…è®¸æ•°æ®ä¸ä¸€è‡´* æ—¶ï¼Œå¯ä»¥ç›‘æ§ä»¥ä¸‹æ•°æ®ï¼Œå¹¶æ ¹æ®æ‰€å¾—æ•°æ®è¿›è¡Œä¸‹ä¸€æ­¥ç­–ç•¥ä¸‹ä¸€æ­¥ç­–ç•¥ã€‚[^4]

- activityç»“æœ (`@activity('Copy data').output`) [^6]
- æ—¥å¿—æ–‡ä»¶

ğŸ“æµ‹è¯•

å¯é€šè¿‡æ¥å›å¤åˆ¶è¿›è¡Œæ•°æ®æ ¡éªŒè¿›è¡Œå®ç°ï¼Œç¤ºä¾‹å¦‚ä¸‹: 

1. å¤‡ä»½ æ•°æ®åº“-1 è‡³ Azure Blob Storage
2. Azure Blob Storage å°†å¤‡ä»½æ•°æ®æ¢å¤è‡³ æ•°æ®åº“-2
3. æ•°æ®åº“-1 å’Œ æ•°æ®åº“-2 çš„æ•°æ®è¿›è¡Œä¸€ä¸€æ¯”è¾ƒã€‚

ç›®çš„: æ•°æ®åœ¨ä¼ è¾“ä¸­æ˜¯å¦æœ‰ä¸å¯é¢„æ–™æŸå¤±å’Œå˜å½¢ã€‚

ğŸ“ç‰¹æ®Šéœ€æ±‚

ç›‘æ§ Copy Activity çš„è¿è¡Œæ—¶é•¿ï¼Œå½“æ—¶é•¿è¿‡é•¿æ—¶ï¼Œå‘é€ç›‘æ§ä¿¡æ¯è‡³è¿ç»´äººå‘˜ã€‚[^6]

### å…¶ä»–

- å‹ç¼©åŠŸèƒ½

## Delete Activity 

Delete Activity ä»…ä»…ç”¨äºåˆ é™¤æ–‡ä»¶ã€‚å¦‚éœ€å®šæ—¶åˆ é™¤æ–‡ä»¶ï¼Œåˆ™è¦ä¸ schedule trigger ä¸€èµ·ä½¿ç”¨



## å‚è€ƒ References

[^1]: [Data Integration Units](https://docs.microsoft.com/en-us/azure/data-factory/copy-activity-performance-features#data-integration-units)
[^2]: [Schema and data type mapping in copy activity - Microsoft Docs](https://docs.microsoft.com/en-us/azure/data-factory/copy-activity-schema-and-type-mapping)

[^3]:[Troubleshoot copy activity on Azure IR](https://docs.microsoft.com/en-us/azure/data-factory/copy-activity-performance-troubleshooting#troubleshoot-copy-activity-on-azure-ir)
[^4]: [Fault tolerance](https://docs.microsoft.com/en-us/azure/data-factory/copy-activity-fault-tolerance)
[^5]: [Data consistency verification in copy activity - Azure](https://docs.microsoft.com/en-us/azure/data-factory/copy-activity-data-consistency)
[^6]: [Monitor copy activity](https://docs.microsoft.com/en-us/azure/data-factory/copy-activity-monitoring)
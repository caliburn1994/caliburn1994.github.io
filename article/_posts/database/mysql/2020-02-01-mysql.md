---
layout: post
title: mysql
date: 2020-02-01 00:00:02
tags: mysql
comments: 1
excerpt:
typora-root-url: ..
---

## 主键

### 必须使用主键吗？

答：是的。

> When you define a `PRIMARY KEY` on your table, `InnoDB` uses it as the clustered index. Define a primary key for each table that you create. If there is no logical unique and non-null column or set of columns, add a new [auto-increment](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_auto_increment) column, whose values are filled in automatically.

[MySQL官网](https://dev.mysql.com/doc/refman/8.0/en/innodb-index-types.html) 中写到，如果不创建主键（`PRIMARY KEY` ），又没有唯一部位空的一个属性，那么将自动创建一个自增加的属性，用作 clustered 索引。

### clustered索引是什么？

MySQL有若干个存储引擎，其中一个存储引擎叫 [InnoDB](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_innodb)，它使用了的是 B-tree。<sup>[[mysql]](https://dev.mysql.com/doc/refman/8.0/en/innodb-physical-structure.html)</sup>

> With the exception of spatial indexes, `InnoDB` indexes are [B-tree](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_b_tree) data structures. Spatial indexes use [R-trees](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_r_tree),

B-tree 使用的物理索引是 clustered index，而不是hashed index。B-tree 有以下特性：<sup>[[wik]i](https://zh.wikipedia.org/wiki/B%E6%A0%91)</sup>

> 在计算机科学中，B树（英语：B-tree）是一种自平衡的树，能够保持数据有序。这种数据结构能够让查找数据、顺序访问、插入数据及删除的动作，都在对数时间内完成。

### 必须使用ID，不能使用字符串作为主键吗?

答：不应该使用字符串作为主键。因为字符串翻译成字节，将是随机数字，不利于 B-tree 的插入。

### 使用自增主键（auto-increment）还是UUID?

如果数据库系统是十分简单，那么可以使用自增主键。缺点：<sup>[[Leaf——美团点评分布式ID生成系统]](https://tech.meituan.com/2017/04/21/mt-leaf.html)</sup>

> 数据日渐增长，对数据分库分表后需要有一个唯一ID来标识一条数据或消息，数据库的自增ID显然不能满足需求

### 如何选择 UUID 算法？

参考上述美团的文章：

- 通过时间戳使数据有序。
- 增加服务号，以便分开服务/数据库。

## 批量插入

场景：

> 需要大量插入数据，一次插入十几万。

### Select For Insert 

```mysql
SET SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
INSERT INTO t1 SELECT ....;
```

ref: https://stackoverflow.com/a/34914508/4883754

<!--事务等级设置为：[READ UNCOMMITTED](https://www.liaoxuefeng.com/wiki/1177760294764384/1219071817284064)，可能出现脏读。-->
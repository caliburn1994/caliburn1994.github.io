---
layout: post
title: AWS-AIM-创建角色（图文教程）
date: 2020-06-27 00:00:02
tags: [AWS,kubernetes]
comments: 1
excerpt: AWS-AIM-创建角色图文
typora-root-url: ..
---

## 概要

![img](https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/images/tutorial-cross-accounts.png)

1. 账号一
   1. 创建策略
   2. 创建角色（将策略、账号二添加进去，以此关联账号）
2. 账号二
   1. 创建群，并关联角色
   2. 创建该群下的用户
   3. 该用户使用角色



## 演示账号

这两有两个账号，分别是：

- 账号一：`684454806125 `的`kyakya `
- 账号二：`417942197288`的`kyakya_02`

![image-20200626204931372](/../assets/blog_res/image-20200626204931372.png)

![image-20200626204508652](/../assets/blog_res/image-20200626204508652.png)

## 添加策略 - 账号1

根据[官方教程](https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/tutorial_cross-account-with-roles.html?icmpid=docs_iam_console)，我们在`kyakya`账号中设置了如下策略<sup>policy</sup>：

![image-20200626205213403](/../assets/blog_res/image-20200626205213403.png)

```json
# 策略名：read-write-app-bucket
# JSON内容：
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "s3:ListAllMyBuckets",
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:ListBucket",
        "s3:GetBucketLocation"
       ],
      "Resource": "arn:aws:s3:::productionapp"
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject"
      ],
      "Resource": "arn:aws:s3:::productionapp/*"
    }
  ]
}
```

## 创建角色 - 账号1



创建角色使用的ID是`kyakya_02`的ID，如下所示：

![image-20200626205511971](/../assets/blog_res/image-20200626205511971.png)

使用刚刚创建的策略`read-write-app-bucket`：

![image-20200626205629382](/../assets/blog_res/image-20200626205629382.png)

角色名为`UpdateApp`：

![image-20200626205733830](/../assets/blog_res/image-20200626205733830.png)

创建结果：

![image-20200626205840500](/../assets/blog_res/image-20200626205840500.png)

摘要<sup>Summary</sup>

![image-20200626205917132](/../assets/blog_res/image-20200626205917132.png)

这里的

- Role ARN<sup>**A**mazon **R**esource **N**ame</sup>信息（**arn:aws:iam::684454806125:role/UpdateApp**）等等JSON文件需要用到。
- `Give this link to users who can switch roles in the console` ：账号2的用户设置完一切后，可用该链接就可以**切换角色**。

## 添加策略 - 账号2

`kyakya_02`账号中有两个群<sup>Group</sup>，如图：

![image-20200626213753494](/../assets/blog_res/image-20200626213753494.png)

分别是：

- Developers
- Testers

### Developers

为(Group)Developers添加策略：

![image-20200626214200942](/../assets/blog_res/image-20200626214200942.png)

点击自定义策略<sup>Custom Policy</sup>，如图：

![image-20200626215255118](/../assets/blog_res/image-20200626215255118.png)

添加的内容如下：

![image-20200626214342777](/../assets/blog_res/image-20200626214342777.png)

```json
# 名称 UpdateApp 
# 内容
{
  "Version": "2012-10-17",
  "Statement": {
    "Effect": "Allow",
    "Action": "sts:AssumeRole",
    "Resource": "arn:aws:iam::684454806125:role/UpdateApp" #对应ARN
  }
}
```

### Testers

```json
# 名称 UpdateApp 
# 内容
{
  "Version": "2012-10-17", 
  "Statement": {
    "Effect": "Deny",
    "Action": "sts:AssumeRole",
    "Resource": "arn:aws:iam::684454806125:role/UpdateApp" #对应ARN
  }
}
```

### 检验1 - 切换角色

![image-20200626215519581](/../assets/blog_res/image-20200626215519581.png)

添加完毕后，我们发现**内联策略<sup>Inline Policy</sup>**被打上**√**了，说明整个操作的目的是为**内联策略**。

这时，我们试着添加用户<sup>User</sup>到组<sup>Group</sup>中：

![image-20200627005140981](/../assets/blog_res/image-20200627005140981.png)

创建后，我们用这个用户<sup>User</sup>登陆一下：

![image-20200627005304978](/../assets/blog_res/image-20200627005304978.png)

这时，我们是**普通用户**。

再通过账号1`kyakya`中有这个链接：

![image-20200627004958948](/../assets/blog_res/image-20200627004958948.png)

我们成功切换了角色：

![image-20200627005410577](/../assets/blog_res/image-20200627005410577.png)

在第一次切换完毕后，我们的设置处，就会有记录了，下次就不用该链接了：

![image-20200627005519687](/../assets/blog_res/image-20200627005519687.png)

### 检验2 - 切换角色

刚刚我们还创建了一个`Testers`群<sup>Group</sup>，该群设置`Effect`为`Deny`，也就是不允许进行切换角色。

我们创建一个角色看看：

![image-20200627011751048](/../assets/blog_res/image-20200627011751048.png)

通过这个角色登陆后，进行切换时，出现该警告⚠：

![image-20200627011831187](/../assets/blog_res/image-20200627011831187.png)

证明了该用户真的没权限切换。

### 详解

在[Testers](#testers)和[Developers](#developers)的章节我们出现了该配置：

```json
{
  "Version": "2012-10-17", 
  "Statement": {
    "Effect": "Deny",
    "Action": "sts:AssumeRole",
    "Resource": "arn:aws:iam::684454806125:role/UpdateApp" #对应ARN
  }
}
```

详解：

- `Effect`：默认值为Deny，如果我们想要使用该资源，必须设置成Allow。

- ` "Action": "sts:AssumeRole"`： assume role可以理解成**开始成为某个角色**<sup class='sup' data-title="content : to begin (a role, duty, etc.) as a job or responsibility">[merriam-webster]</sup>

- `Resource`：值为[上文](#创建角色---账号1)中的Role ARN<sup>**A**mazon **R**esource **N**ame</sup>的内容。

## k8s本地初始化配置 - 账号2

账号2该如何初始化K8s本地配置呢？

### 初始化aws账号

在AWS IAM的用户界面上，找到`Create access key`创建访问密钥

![image-20200804212514836](/../assets/blog_res/image-20200804212514836.png)

运行下面的命令时，输入页面上的`Access key ID`和`Secret access key`

```shell
$ aws configure
AWS Access Key ID [None]: 
AWS Secret Access Key [None]: 
Default region name [None]: region-code # 地区
Default output format [None]: json
```

### 初始化EKS集群配置

首先，我们知道一个**用户**可能会同时**操作多个地区**（如同时操作东京地区和北美地区），而**每个地区**可能**有若干个集群**，而在**执行每个地区**时可能是以**某个身份**进行操作。

#### 非集群创建者

所以非集群创建执行以下类似的命令：

```shell
aws eks update-kubeconfig  \
--name eksworkshop-eksctl  \ # 集群名
--region ap-northeast-1 \  # 地区名
--role-arn arn:aws:iam::684454806125:role/UpdateApp  # 以什么身份进行执行
```

可参考文档：

- [官方教程](https://www.eksworkshop.com/beginner/091_iam-groups/)
- [aws支持文章](https://aws.amazon.com/cn/premiumsupport/knowledge-center/eks-iam-permissions-namespaces/)、[aws支持文档-图文](https://dev.classmethod.jp/articles/sts-sessionname/)、[aws支持文档-指令](https://docs.aws.amazon.com/cli/latest/reference/sts/assume-role.html)

#### 集群创建者

集群创建者在创建完集群后（在创建期间已经指定了地区、集群名），就可以直接使用。<sup>[[aws]](https://www.eksworkshop.com/030_eksctl/launcheks/)</sup> 值得一提的是，这里并没有需要指定身份，笔者推测是以为创建者被赋予`Default`角色。

## 外部链接

- [官方教程](https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/tutorial_cross-account-with-roles.html?icmpid=docs_iam_console)
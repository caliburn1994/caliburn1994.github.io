---
layout: post
title: 1.SSH介绍
tags: Linux-Network
comments: 1
excerpt: SSH命令基础用法示例
typora-root-url: ..\..\..\..
typora-copy-images-to: ..\..\..\..\assets\blog_res
---

## 定义 Definition

SSH，全称 Secure Shell Protocol，可理解成 **安全且可靠的保护壳协议**。首先，我们需要分清两个讲法：

1. 通常我们说 SSH 时，是说 OpenSSH远程登录客户端。

   ```bash
   $ man ssh
   NAME
        ssh — OpenSSH remote login client
   ```

   而探及 <u>SSH服务器</u> 时，则指代 <u>OpenSSH服务器</u>，通常指代的是 sshd（OpenSSH daemon）。

   包含 Windows 10 的绝大多数操作系统都是使用着 OpenSSH。<sup>[wiki](https://zh.wikipedia.org/wiki/Secure_Shell#OpenSSH%E5%92%8COSSH)</sup>

2. 当谈及 <u>SSH协议</u> 时，才是指上述定义中的 Secure Shell Protocol。

就如同名字所示，SSH 是在不安的网络中，充当着可靠的保护壳的协议。<sup>[wiki](https://en.wikipedia.org/wiki/Secure_Shell_Protocol)</sup>

## 如何运行 How does it work

SSH 的过程分为三个部分：<sup>[medium博客](https://medium.com/@Magical_Mudit/understanding-ssh-workflow-66a0e8d4bf65)</sup>

1. 对服务器请求进行验证。
2. 生成用于交互的 session key，该 key 用于加密数据。另外还进行协议交涉（negotiate）
3. 对客户端进行验证。

### (客户端)对服务端的校验 Verification of the server

1. 当客户端 **第一次** 访问服务器时，客户端将会询问用户 **服务端的 public key 是否正确**。如果用户确认正确，那么公 <u>服务端的 public key</u> 将会存在客户端主机上。
2. 当客户端再次访问时，客户端将对比 <u>服务端的 public key</u> 和 <u>客户端主机上所记录的 public key</u> 是否一致。
   - 如果 public key不一致，那么将警告提示。

细节：

- 客户端记录 public key 的位置是：
  - 用户专属 ` ~/.ssh/known_hosts`（第一次访问时，点击确认后，将自动添加到此处）
  - 系统专属 `/etc/ssh/ssh_known_hosts`（手动）
- 服务器端的非对称密钥，又叫做 **Host Key** ，常见对称加密算法的有 RSA、ECDSA 。Host Keys 存储在 `/etc/ssh`，public key 的文件扩展名<sup>filename extension</sup>为 `.pub`，如：
  - `ssh_host_ed25519_key.pub`
  - `ssh_host_rsa_key.pub`
  - `ssh_host_ecdsa_key.pub`
  - ...

### 生成 session key 以及 Negotiate

session key 通常为对称密钥，因为非对称密钥加密时间长。

设置Key Exchange Algorithm : 

```properties
KexAlgorithms    curve25519-sha256,curve25519-sha256@libssh.org,ecdh-sha2-nistp256,ecdh-sha2-nistp384,ecdh-sha2-nistp521
```

### (服务端)对客户端进行认证 Authentication of the client 

 Authentication method 有：

1. GSSAPI-based authentication 
2. host-based authentication
3. public key authentication
4. challenge-response authentication
5. password authentication

在验证时，会根据上方的 Authentication  method的顺序进行验证。可通过 `PreferredAuthentications` 修改默认顺序。<sup>[[openbsd]](http://man.openbsd.org/ssh.1#AUTHENTICATION)</sup> 由于 GSSAPI-based 验证时候过长，有一些应用会通过 disable 它，从而skip。

- 如果选择的是 password authentication ，那么将会校验密码
- 如果选择 public key authentication ，那么将会 `~/.ssh/authorized_keys` 查找公开密钥，并校验。

## 目录结构 Dir structure

```shell
$ ls -tlr /etc/ssh/ 
total 580
-rw-r--r-- 1 root root   3264 Mar  4  2019 sshd_config
-rw-r--r-- 1 root root   1580 Mar  4  2019 ssh_config
-rw-r--r-- 1 root root 553122 Mar  4  2019 moduli
-rw-r--r-- 1 root root    338 Feb 27  2020 ssh_import_id
-rw-r--r-- 1 root root    393 Feb 27  2020 ssh_host_rsa_key.pub
-rw------- 1 root root   1679 Feb 27  2020 ssh_host_rsa_key
-rw-r--r-- 1 root root    173 Feb 27  2020 ssh_host_ecdsa_key.pub
-rw------- 1 root root    227 Feb 27  2020 ssh_host_ecdsa_key
-rw-r--r-- 1 root root     93 Feb 27  2020 ssh_host_ed25519_key.pub
-rw------- 1 root root    399 Feb 27  2020 ssh_host_ed25519_key
```

- **sshd_config** : OpenSSH服务端 配置文件 <sup>[[来源]](https://linux.die.net/man/5/sshd_config)</sup> 
- **ssh_config** : OpenSSH客户端 配置文件

其他：

- 记录 <u>来自服务端 public key</u>：
  - `~/.ssh/known_hosts` 
  -  `/etc/ssh/ssh_known_hosts`
- 记录 <u>来自客户端 public key</u>
  - `~/.ssh/authorized_keys`

## 工具

### 密钥认证 ssh-keygen

`ssh-keygen` — OpenSSH authentication key utility

```shell
# 根据主机名，查找信息
# https://en.wikibooks.org/wiki/OpenSSH/Client_Configuration_Files#~/.ssh/known_hosts
# usage: ssh-keygen -F [hostname] 
$ ssh-keygen -F ubuntu | tee test01

# 生成密钥
ssh-keygen -t rsa

# hash 主机名
ssh-keygen -f  ~/.ssh/known_hosts  -H 

# 生成 Fingerprint
ssh-keygen -l -f /etc/ssh/ssh_host_rsa_key
```

### 认证代理 ssh-agent

ssh-agent 是一个代理，帮助用户管理密钥对。

### 第三方服务 Third-party service

**Cloudflare Access **提供了 <u>管理SSH密钥</u> 以及<u>单点登录</u>的服务，并且取缔了 private network 的不安全性。更多查看 [仅凭公钥无以保障SSH安全](https://blog.cloudflare.com/zh-cn/public-keys-are-not-enough-for-ssh-security-zh-cn/)。



## 延伸阅读

- [RedHat - 第 12 章 使用 OPENSSH 的两个系统间使用安全通讯](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/8/html/configuring_basic_system_settings/using-secure-communications-between-two-systems-with-openssh_configuring-basic-system-settings)
- [阮一峰 - SSH原理与运用（一）：远程登录](http://www.ruanyifeng.com/blog/2011/12/ssh_remote_login.html)
- [ssh-agent代理的简单用法](https://bbs.huaweicloud.com/blogs/118363)

